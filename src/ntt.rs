// const ROOTS: [i64; 256] = [
//     1, 316072, 27265632, 24182947, 51722345, 21146784, 84329901, 79681889, 91138177, 57592067,
//     51436981, 34570752, 80947214, 24568964, 37114197, 65442469, 92959680, 97272325, 722025,
//     71728654, 66520465, 16591207, 14114338, 30375226, 44731793, 19674266, 4106187, 89649374,
//     65479245, 37980556, 48531997, 49158624, 71475241, 10113124, 96816540, 12469016, 712407,
//     52138588, 96240894, 95749752, 6903949, 13562334, 35254111, 12997636, 55102268, 8074149,
//     84548421, 81474163, 54200918, 40074179, 16597640, 33811894, 46181580, 63522699, 3173946,
//     23118628, 21101598, 98815211, 72090734, 37072928, 9145950, 63707528, 28230654, 81862782,
//     56574666, 50369223, 24454888, 24210523, 8591570, 22357108, 51069429, 46026882, 98141409,
//     39670305, 25170220, 94742582, 17819031, 75411092, 24271960, 96608282, 32457814, 48731751,
//     59644925, 21826712, 39413782, 93255450, 50464116, 14930246, 75385561, 9012208, 77072124,
//     86121530, 40237552, 5552143, 30102466, 14740009, 52566054, 94142544, 43127299, 7599895,
//     98183142, 41264870, 20035814, 7867708, 74761957, 36064118, 5101357, 11018489, 25009737,
//     12439349, 87694397, 23191198, 3479370, 7279077, 81035013, 88462217, 71563028, 70213513,
//     5437149, 29083739, 97959184, 32227637, 87636370, 6183196, 41838221, 16807286, 49812308,
//     87979077, 95613025, 83590435, 32723938, 95543044, 13405942, 37845258, 73486966, 67871809,
//     55385173, 22866581, 94409566, 71732205, 81415646, 83676998, 7991242, 56684177, 29919751,
//     53781423, 44590416, 36141486, 94477051, 57758753, 80741210, 52226283, 26582978, 12924242,
//     13640530, 84298378, 83432652, 99057338, 85098318, 14709660, 24666621, 95775115, 69743286,
//     83737642, 46722220, 91270122, 80324173, 28210048, 12382734, 13581654, 304610, 28916884,
//     15238787, 37945624, 82269803, 35883860, 15294227, 42712810, 84177349, 87833344, 44106466,
//     5532525, 71542192, 28716586, 34168680, 55003452, 86484188, 92799950, 51611946, 62963363,
//     6245590, 29617113, 44080437, 34228279, 65478233, 20154735, 41945007, 41178743, 81896221,
//     54339769, 30646535, 18821829, 92144760, 62502083, 93411199, 45998035, 41583715, 17651973,
//     29207760, 32449106, 14728162, 33209267, 58616888, 82126316, 90196927, 63279422, 29402286,
//     1385887, 83463514, 87742345, 76259304, 10344721, 3335756, 21451000, 89394098, 24307854,
//     64892697, 98553502, 11221787, 48178715, 40376549, 42271011, 86601368, 79994302, 69372852,
//     90391397, 14516171, 81457461, 10509786, 23685678, 39897018, 99548365, 36916160, 94253387,
//     40967007, 9383413, 12070838, 98076522, 69361365, 84140849, 28688978, 67185151, 87410033,
//     50648123, 82214813, 72669393,
// ];

use crate::param::Q;

// normalization factor: 1/N mod Q
const NORM_FACTOR: i64 = 100286401;

// root = 316072
// roots = [root^i for i in range(513)]

const W: [i128; 513] = [
    183222114834,
    57911380280053980,
    4995666757346455132,
    4430850692277046250,
    9476677435113355777,
    3874558486433980325,
    15451102805026400416,
    14599484216609032661,
    16698529532125177887,
    10552140313445504810,
    9424392439535647773,
    6334126292868196800,
    14831319739062332234,
    4501577543379217899,
    6800141664734106770,
    11990507570188577044,
    17032269163963047629,
    17822441101394624605,
    132290947463571512,
    13142275680131156994,
    12188020277091994842,
    3039876034201364113,
    2586058857852693487,
    5565413146303952718,
    8195853713810956602,
    3604760624341721198,
    752344266047020973,
    16425747897892834604,
    11997245746683740377,
    6958877792920239317,
    8892135127494491543,
    9006947051647056103,
    13095844814344534581,
    1852947966866222346,
    17738931209784661042,
    2284599481428527554,
    130528717163090738,
    9552942357858523045,
    17633460132268487659,
    17543472056344311294,
    1264956136491363984,
    2484919517575443629,
    6459332774039567273,
    2381454355772481257,
    10095954075152020667,
    1479362655271006495,
    15491140501560093359,
    14927868449252397045,
    9930806821945704843,
    7342475826646945429,
    3041054702066096159,
    6195086725248916372,
    8461486754010906676,
    11638763250792239406,
    581537098491344410,
    4235843914238223538,
    3866279411953056614,
    18105131937263576507,
    13208616743470528862,
    6792580271276990835,
    1675740301173022922,
    11672628011055034266,
    5172480129048530141,
    14999072044297368753,
    10365729950590499623,
    9228755560643908303,
    4480676297407327197,
    4435903225315729742,
    1574165625150925660,
    4096316609349252965,
    9357048784783900068,
    8433142659290198133,
    17981676509843681888,
    7268477178240169374,
    4611740939256309624,
    17358936238946180591,
    3264840544126245148,
    13816979758239060950,
    4447159842384833226,
    17700773738593402462,
    5946989323993457193,
    8928734477821195278,
    10928269297660971710,
    3999136332529352717,
    7221476491676410841,
    17086460768867726202,
    9246142056786923699,
    2735551247123297283,
    13812301914425214553,
    1651235809090791723,
    14121317554087281048,
    15779368859405696376,
    7372409373213845562,
    1017275382325039061,
    5515437482261622098,
    2700695621663476011,
    9631263582398480886,
    17248996007604957610,
    7901874929891264471,
    1392468834422159648,
    17989322918362081153,
    7560636749781667119,
    3671004213516000971,
    1441538098662402684,
    13698043870725795490,
    6607743969610531118,
    934681418067134490,
    2018830856863599753,
    4582336904601281963,
    2279163830947724568,
    16067552877499509380,
    4249140343111782465,
    637497529692637808,
    1333687881985099871,
    14847406457522709805,
    16208234481711938976,
    13111929334139534134,
    12864668341838295659,
    996205938451730045,
    5328784166882346011,
    17948288859967916756,
    5904815807267135390,
    16056921047841992446,
    1132898247557862293,
    7665687332544294715,
    3079466485552745393,
    9126716416560704911,
    16119712549150670404,
    17518420646249298320,
    15315616280657995760,
    5995749126081744310,
    17505598579431046600,
    2456265044592204993,
    6934088207227325223,
    13464437323310503074,
    12435616382641266103,
    10147788527549349982,
    4189663329860465415,
    17297920343152366346,
    13142926301860935246,
    14917146840758611076,
    15331476536584437560,
    1464172259396400597,
    10385794787608169620,
    5481960053549587931,
    9853946060883094917,
    8169950320881961969,
    6621919498191067250,
    17310285087571990491,
    10582680874878852521,
    14793575250517911216,
    9569010021218957800,
    4870589447766043170,
    2368006951876298483,
    2499246754067062946,
    15445327094300464105,
    15286706945713021965,
    18149494958262173757,
    15591893792841386367,
    2695135013700355715,
    4519470465447636587,
    17548119118842865449,
    12778512356445888414,
    15342587858516477075,
    8560543958175174260,
    16722704774067051012,
    14717164849413565143,
    5168704654150244964,
    2268790710916354322,
    2488459368834051297,
    55811288399817898,
    5298212640911591225,
    2792082781656530645,
    6952477478004831290,
    15073647292699529815,
    6574716717634645970,
    2802240615702970041,
    7825931378735517381,
    15423151904964127280,
    16093011040689455533,
    8081279978407677237,
    1013680930876210633,
    13108111718154836962,
    5261513617754417378,
    6260457810712352993,
    10077848798652508486,
    15845815825127442739,
    17003003095560490547,
    9456449896857712507,
    11536280525969021047,
    1144330208190862647,
    5426510079160224190,
    8076510889980643128,
    6271377665534390178,
    11997060325903527594,
    3692793170634266111,
    7685252889299039977,
    7544856378697293276,
    15005198808595328475,
    9956247395812626858,
    5615122955057658093,
    3448575314438318255,
    16882957798141900582,
    11451763828838040448,
    17114997430031126083,
    8427857250943559654,
    7619056204986157903,
    3234231824066178904,
    5351507556786268455,
    5945393825817476056,
    2698524989269028545,
    6084672131852386183,
    10739910184392583957,
    15047357301108233827,
    16526071716536954922,
    11594189524361582176,
    5387149021896616036,
    253925147062008563,
    15292361546621052496,
    16076338011461606713,
    13972390954707287008,
    1895381658995609516,
    611184268892757805,
    3930297585320553327,
    16378975689306275023,
    4453736416974712296,
    11889777181671638381,
    18057181060812284880,
    2056079546365277896,
    8827406052321435941,
    7397876697509533453,
    7744984031623632847,
    15867285792543780553,
    14656725187170906235,
    12710640655559186915,
    16561702921208871756,
    2659683549923091786,
    14924808273490426793,
    1925625217380810072,
    4339740014455277277,
    7310016013560703550,
    18239461963643144124,
    6763856906778574328,
    17269304896479587515,
    7506061660990639382,
    1719248774228030826,
    2211644466187850323,
    17969787776478398463,
    12708535983126079964,
    15416464297772658341,
    5256455221608059174,
    12309805451713055740,
    16015451104036636142,
    9279856208471324382,
    15063571908604766064,
    13314639869218699394,
    18446743890487436781,
    18388832693429497635,
    13451077316363096483,
    14015893381432505365,
    8970066638596195838,
    14572185587275571290,
    2995641268683151199,
    3847259857100518954,
    1748214541584373728,
    7894603760264046805,
    9022351634173903842,
    12112617780841354815,
    3615424334647219381,
    13945166530330333716,
    11646602408975444845,
    6456236503520974571,
    1414474909746503986,
    624302972314927010,
    18314453126245980103,
    5304468393578394621,
    6258723796617556773,
    15406868039508187502,
    15860685215856858128,
    12881330927405598897,
    10250890359898595013,
    14841983449367830417,
    17694399807662530642,
    2020996175816717011,
    6449498327025811238,
    11487866280789312298,
    9554608946215060072,
    9439797022062495512,
    5350899259365017034,
    16593796106843329269,
    707812863924890573,
    16162144592281024061,
    18316215356546460877,
    8893801715851028570,
    813283941441063956,
    903272017365240321,
    17181787937218187631,
    15961824556134107986,
    11987411299669984342,
    16065289717937070358,
    8350789998557530948,
    16967381418438545120,
    2955603572149458256,
    3518875624457154570,
    8515937251763846772,
    11104268247062606186,
    15405689371643455456,
    12251657348460635243,
    9985257319698644939,
    6807980822917312209,
    17865206975218207205,
    14210900159471328077,
    14580464661756495001,
    341612136445975108,
    5238127330239022753,
    11654163802432560780,
    16771003772536528693,
    6774116062654517349,
    13274263944661021474,
    3447672029412182862,
    8081014123119051992,
    9217988513065643312,
    13966067776302224418,
    14010840848393821873,
    16872578448558625955,
    14350427464360298650,
    9089695288925651547,
    10013601414419353482,
    465067563865869727,
    11178266895469382241,
    13835003134453241991,
    1087807834763371024,
    15181903529583306467,
    4629764315470490665,
    13999584231324718389,
    745970335116149153,
    12499754749716094422,
    9518009595888356337,
    7518474776048579905,
    14447607741180198898,
    11225267582033140774,
    1360283304841825413,
    9200602016922627916,
    15711192826586254332,
    4634442159284337062,
    16795508264618759892,
    4325426519622270567,
    2667375214303855239,
    11074334700495706053,
    17429468691384512554,
    12931306591447929517,
    15746048452046075604,
    8815480491311070729,
    1197748066104594005,
    10544869143818287144,
    17054275239287391967,
    457421155347470462,
    10886107323927884496,
    14775739860193550644,
    17005205975047148931,
    4748700202983756125,
    11839000104099020497,
    17512062655642417125,
    16427913216845951862,
    13864407169108269652,
    16167580242761827047,
    2379191196210042235,
    14197603730597769150,
    17809246544016913807,
    17113056191724451744,
    3599337616186841810,
    2238509591997612639,
    5334814739570017481,
    5582075731871255956,
    17450538135257821570,
    13117959906827205604,
    498455213741634859,
    12541928266442416225,
    2389823025867559169,
    17313845826151689322,
    10781056741165256900,
    15367277588156806222,
    9320027657148846704,
    2327031524558881211,
    928323427460253295,
    3131127793051555855,
    12450994947627807305,
    941145494278505015,
    15990479029117346622,
    11512655866482226392,
    4982306750399048541,
    6011127691068285512,
    8298955546160201633,
    14257080743849086200,
    1148823730557185269,
    5303817771848616369,
    3529597232950940539,
    3115267537125114055,
    16982571814313151018,
    8060949286101381995,
    12964784020159963684,
    8592798012826456698,
    10276793752827589646,
    11824824575518484365,
    1136458986137561124,
    7864063198830699094,
    3653168823191640399,
    8877734052490593815,
    13576154625943508445,
    16078737121833253132,
    15947497319642488669,
    3001416979409087510,
    3160037127996529650,
    297249115447377858,
    2854850280868165248,
    15751609060009195900,
    13927273608261915028,
    898624954866686166,
    5668231717263663201,
    3104156215193074540,
    9886200115534377355,
    1724039299642500603,
    3729579224295986472,
    13278039419559306651,
    16177953362793197293,
    15958284704875500318,
    18390932785309733717,
    13148531432797960390,
    15654661292053020970,
    11494266595704720325,
    3373096781010021800,
    11872027356074905645,
    15644503458006581574,
    10620812694974034234,
    3023592168745424335,
    2353733033020096082,
    10365464095301874378,
    17433063142833340982,
    5338632355554714653,
    13185230455955134237,
    12186286262997198622,
    8368895275057043129,
    2600928248582108876,
    1443740978149061068,
    8990294176851839108,
    6910463547740530568,
    17302413865518688968,
    13020233994549327425,
    10370233183728908487,
    12175366408175161437,
    6449683747806024021,
    14753950903075285504,
    10761491184410511638,
    10901887695012258339,
    3441545265114223140,
    8490496677896924757,
    12831621118651893522,
    14998168759271233360,
    1563786275567651033,
    6994980244871511167,
    1331746643678425532,
    10018886822765991961,
    10827687868723393712,
    15212512249643372711,
    13095236516923283160,
    12501350247892075559,
    15748219084440523070,
    12362071941857165432,
    7706833889316967658,
    3399386772601317788,
    1920672357172596693,
    6852554549347969439,
    13059595051812935579,
    18192818926647543052,
    3154382527088499119,
    2370406062247944902,
    4474353119002264607,
    16551362414713942099,
    17835559804816793810,
    14516446488388998288,
    2067768384403276592,
    13993007656734839319,
    6556966892037913234,
    389563012897266735,
    16390664527344273719,
    9619338021388115674,
    11048867376200018162,
    10701760042085918768,
    2579458281165771062,
    3790018886538645380,
    5736103418150364700,
    1885041152500679859,
    15787060523786459829,
    3521935800219124822,
    16521118856328741543,
    14107004059254274338,
    11136728060148848065,
    207282110066407491,
    11682887166930977287,
    1177439177229964100,
    10940682412718912233,
    16727495299481520789,
    16235099607521701292,
    476956297231153152,
    5738208090583471651,
    3030279775936893274,
    13190288852101492441,
    6136938621996495875,
    2431292969672915473,
    9166887865238227233,
    3383172165104785551,
    5132104204490852221,
    183222114834,
];
const ROOTS: [i64; 513] = [
    1, 316072, 27265632, 24182947, 51722345, 21146784, 84329901, 79681889, 91138177, 57592067,
    51436981, 34570752, 80947214, 24568964, 37114197, 65442469, 92959680, 97272325, 722025,
    71728654, 66520465, 16591207, 14114338, 30375226, 44731793, 19674266, 4106187, 89649374,
    65479245, 37980556, 48531997, 49158624, 71475241, 10113124, 96816540, 12469016, 712407,
    52138588, 96240894, 95749752, 6903949, 13562334, 35254111, 12997636, 55102268, 8074149,
    84548421, 81474163, 54200918, 40074179, 16597640, 33811894, 46181580, 63522699, 3173946,
    23118628, 21101598, 98815211, 72090734, 37072928, 9145950, 63707528, 28230654, 81862782,
    56574666, 50369223, 24454888, 24210523, 8591570, 22357108, 51069429, 46026882, 98141409,
    39670305, 25170220, 94742582, 17819031, 75411092, 24271960, 96608282, 32457814, 48731751,
    59644925, 21826712, 39413782, 93255450, 50464116, 14930246, 75385561, 9012208, 77072124,
    86121530, 40237552, 5552143, 30102466, 14740009, 52566054, 94142544, 43127299, 7599895,
    98183142, 41264870, 20035814, 7867708, 74761957, 36064118, 5101357, 11018489, 25009737,
    12439349, 87694397, 23191198, 3479370, 7279077, 81035013, 88462217, 71563028, 70213513,
    5437149, 29083739, 97959184, 32227637, 87636370, 6183196, 41838221, 16807286, 49812308,
    87979077, 95613025, 83590435, 32723938, 95543044, 13405942, 37845258, 73486966, 67871809,
    55385173, 22866581, 94409566, 71732205, 81415646, 83676998, 7991242, 56684177, 29919751,
    53781423, 44590416, 36141486, 94477051, 57758753, 80741210, 52226283, 26582978, 12924242,
    13640530, 84298378, 83432652, 99057338, 85098318, 14709660, 24666621, 95775115, 69743286,
    83737642, 46722220, 91270122, 80324173, 28210048, 12382734, 13581654, 304610, 28916884,
    15238787, 37945624, 82269803, 35883860, 15294227, 42712810, 84177349, 87833344, 44106466,
    5532525, 71542192, 28716586, 34168680, 55003452, 86484188, 92799950, 51611946, 62963363,
    6245590, 29617113, 44080437, 34228279, 65478233, 20154735, 41945007, 41178743, 81896221,
    54339769, 30646535, 18821829, 92144760, 62502083, 93411199, 45998035, 41583715, 17651973,
    29207760, 32449106, 14728162, 33209267, 58616888, 82126316, 90196927, 63279422, 29402286,
    1385887, 83463514, 87742345, 76259304, 10344721, 3335756, 21451000, 89394098, 24307854,
    64892697, 98553502, 11221787, 48178715, 40376549, 42271011, 86601368, 79994302, 69372852,
    90391397, 14516171, 81457461, 10509786, 23685678, 39897018, 99548365, 36916160, 94253387,
    40967007, 9383413, 12070838, 98076522, 69361365, 84140849, 28688978, 67185151, 87410033,
    50648123, 82214813, 72669393, 100679680, 100363609, 73414049, 76496734, 48957336, 79532897,
    16349780, 20997792, 9541504, 43087614, 49242700, 66108929, 19732467, 76110717, 63565484,
    35237212, 7720001, 3407356, 99957656, 28951027, 34159216, 84088474, 86565343, 70304455,
    55947888, 81005415, 96573494, 11030307, 35200436, 62699125, 52147684, 51521057, 29204440,
    90566557, 3863141, 88210665, 99967274, 48541093, 4438787, 4929929, 93775732, 87117347,
    65425570, 87682045, 45577413, 92605532, 16131260, 19205518, 46478763, 60605502, 84082041,
    66867787, 54498101, 37156982, 97505735, 77561053, 79578083, 1864470, 28588947, 63606753,
    91533731, 36972153, 72449027, 18816899, 44105015, 50310458, 76224793, 76469158, 92088111,
    78322573, 49610252, 54652799, 2538272, 61009376, 75509461, 5937099, 82860650, 25268589,
    76407721, 4071399, 68221867, 51947930, 41034756, 78852969, 61265899, 7424231, 50215565,
    85749435, 25294120, 91667473, 23607557, 14558151, 60442129, 95127538, 70577215, 85939672,
    48113627, 6537137, 57552382, 93079786, 2496539, 59414811, 80643867, 92811973, 25917724,
    64615563, 95578324, 89661192, 75669944, 88240332, 12985284, 77488483, 97200311, 93400604,
    19644668, 12217464, 29116653, 30466168, 95242532, 71595942, 2720497, 68452044, 13043311,
    94496485, 58841460, 83872395, 50867373, 12700604, 5066656, 17089246, 67955743, 5136637,
    87273739, 62834423, 27192715, 32807872, 45294508, 77813100, 6270115, 28947476, 19264035,
    17002683, 92688439, 43995504, 70759930, 46898258, 56089265, 64538195, 6202630, 42920928,
    19938471, 48453398, 74096703, 87755439, 87039151, 16381303, 17247029, 1622343, 15581363,
    85970021, 76013060, 4904566, 30936395, 16942039, 53957461, 9409559, 20355508, 72469633,
    88296947, 87098027, 100375071, 71762797, 85440894, 62734057, 18409878, 64795821, 85385454,
    57966871, 16502332, 12846337, 56573215, 95147156, 29137489, 71963095, 66511001, 45676229,
    14195493, 7879731, 49067735, 37716318, 94434091, 71062568, 56599244, 66451402, 35201448,
    80524946, 58734674, 59500938, 18783460, 46339912, 70033146, 81857852, 8534921, 38177598,
    7268482, 54681646, 59095966, 83027708, 71471921, 68230575, 85951519, 67470414, 42062793,
    18553365, 10482754, 37400259, 71277395, 99293794, 17216167, 12937336, 24420377, 90334960,
    97343925, 79228681, 11285583, 76371827, 35786984, 2126179, 89457894, 52500966, 60303132,
    58408670, 14078313, 20685379, 31306829, 10288284, 86163510, 19222220, 90169895, 76994003,
    60782663, 1131316, 63763521, 6426294, 59712674, 91296268, 88608843, 2603159, 31318316,
    16538832, 71990703, 33494530, 13269648, 50031558, 18464868, 28010288, 1,
];

const POSITION: [usize; 256] = [
    0, 128, 64, 192, 32, 160, 96, 224, 16, 144, 80, 208, 48, 176, 112, 240, 8, 136, 72, 200, 40,
    168, 104, 232, 24, 152, 88, 216, 56, 184, 120, 248, 4, 132, 68, 196, 36, 164, 100, 228, 20,
    148, 84, 212, 52, 180, 116, 244, 12, 140, 76, 204, 44, 172, 108, 236, 28, 156, 92, 220, 60,
    188, 124, 252, 2, 130, 66, 194, 34, 162, 98, 226, 18, 146, 82, 210, 50, 178, 114, 242, 10, 138,
    74, 202, 42, 170, 106, 234, 26, 154, 90, 218, 58, 186, 122, 250, 6, 134, 70, 198, 38, 166, 102,
    230, 22, 150, 86, 214, 54, 182, 118, 246, 14, 142, 78, 206, 46, 174, 110, 238, 30, 158, 94,
    222, 62, 190, 126, 254, 1, 129, 65, 193, 33, 161, 97, 225, 17, 145, 81, 209, 49, 177, 113, 241,
    9, 137, 73, 201, 41, 169, 105, 233, 25, 153, 89, 217, 57, 185, 121, 249, 5, 133, 69, 197, 37,
    165, 101, 229, 21, 149, 85, 213, 53, 181, 117, 245, 13, 141, 77, 205, 45, 173, 109, 237, 29,
    157, 93, 221, 61, 189, 125, 253, 3, 131, 67, 195, 35, 163, 99, 227, 19, 147, 83, 211, 51, 179,
    115, 243, 11, 139, 75, 203, 43, 171, 107, 235, 27, 155, 91, 219, 59, 187, 123, 251, 7, 135, 71,
    199, 39, 167, 103, 231, 23, 151, 87, 215, 55, 183, 119, 247, 15, 143, 79, 207, 47, 175, 111,
    239, 31, 159, 95, 223, 63, 191, 127, 255,
];

//for i in range(513):
//    v[i] = floor((2^(64)*((root**i)%Q)/Q))
// const W: [i128; 513] = [
//     1, 28010288, 18464868, 50031558, 13269648, 33494530, 71990703, 16538832, 31318316, 2603159,
//     88608843, 91296268, 59712674, 6426294, 63763521, 1131316, 60782663, 76994003, 90169895,
//     19222220, 86163510, 10288284, 31306829, 20685379, 14078313, 58408670, 60303132, 52500966,
//     89457894, 2126179, 35786984, 76371827, 11285583, 79228681, 97343925, 90334960, 24420377,
//     12937336, 17216167, 99293794, 71277395, 37400259, 10482754, 18553365, 42062793, 67470414,
//     85951519, 68230575, 71471921, 83027708, 59095966, 54681646, 7268482, 38177598, 8534921,
//     81857852, 70033146, 46339912, 18783460, 59500938, 58734674, 80524946, 35201448, 66451402,
//     56599244, 71062568, 94434091, 37716318, 49067735, 7879731, 14195493, 45676229, 66511001,
//     71963095, 29137489, 95147156, 56573215, 12846337, 16502332, 57966871, 85385454, 64795821,
//     18409878, 62734057, 85440894, 71762797, 100375071, 87098027, 88296947, 72469633, 20355508,
//     9409559, 53957461, 16942039, 30936395, 4904566, 76013060, 85970021, 15581363, 1622343,
//     17247029, 16381303, 87039151, 87755439, 74096703, 48453398, 19938471, 42920928, 6202630,
//     64538195, 56089265, 46898258, 70759930, 43995504, 92688439, 17002683, 19264035, 28947476,
//     6270115, 77813100, 45294508, 32807872, 27192715, 62834423, 87273739, 5136637, 67955743,
//     17089246, 5066656, 12700604, 50867373, 83872395, 58841460, 94496485, 13043311, 68452044,
//     2720497, 71595942, 95242532, 30466168, 29116653, 12217464, 19644668, 93400604, 97200311,
//     77488483, 12985284, 88240332, 75669944, 89661192, 95578324, 64615563, 25917724, 92811973,
//     80643867, 59414811, 2496539, 93079786, 57552382, 6537137, 48113627, 85939672, 70577215,
//     95127538, 60442129, 14558151, 23607557, 91667473, 25294120, 85749435, 50215565, 7424231,
//     61265899, 78852969, 41034756, 51947930, 68221867, 4071399, 76407721, 25268589, 82860650,
//     5937099, 75509461, 61009376, 2538272, 54652799, 49610252, 78322573, 92088111, 76469158,
//     76224793, 50310458, 44105015, 18816899, 72449027, 36972153, 91533731, 63606753, 28588947,
//     1864470, 79578083, 77561053, 97505735, 37156982, 54498101, 66867787, 84082041, 60605502,
//     46478763, 19205518, 16131260, 92605532, 45577413, 87682045, 65425570, 87117347, 93775732,
//     4929929, 4438787, 48541093, 99967274, 88210665, 3863141, 90566557, 29204440, 51521057,
//     52147684, 62699125, 35200436, 11030307, 96573494, 81005415, 55947888, 70304455, 86565343,
//     84088474, 34159216, 28951027, 99957656, 3407356, 7720001, 35237212, 63565484, 76110717,
//     19732467, 66108929, 49242700, 43087614, 9541504, 20997792, 16349780, 79532897, 48957336,
//     76496734, 73414049, 100363609, 100679680, 72669393, 82214813, 50648123, 87410033, 67185151,
//     28688978, 84140849, 69361365, 98076522, 12070838, 9383413, 40967007, 94253387, 36916160,
//     99548365, 39897018, 23685678, 10509786, 81457461, 14516171, 90391397, 69372852, 79994302,
//     86601368, 42271011, 40376549, 48178715, 11221787, 98553502, 64892697, 24307854, 89394098,
//     21451000, 3335756, 10344721, 76259304, 87742345, 83463514, 1385887, 29402286, 63279422,
//     90196927, 82126316, 58616888, 33209267, 14728162, 32449106, 29207760, 17651973, 41583715,
//     45998035, 93411199, 62502083, 92144760, 18821829, 30646535, 54339769, 81896221, 41178743,
//     41945007, 20154735, 65478233, 34228279, 44080437, 29617113, 6245590, 62963363, 51611946,
//     92799950, 86484188, 55003452, 34168680, 28716586, 71542192, 5532525, 44106466, 87833344,
//     84177349, 42712810, 15294227, 35883860, 82269803, 37945624, 15238787, 28916884, 304610,
//     13581654, 12382734, 28210048, 80324173, 91270122, 46722220, 83737642, 69743286, 95775115,
//     24666621, 14709660, 85098318, 99057338, 83432652, 84298378, 13640530, 12924242, 26582978,
//     52226283, 80741210, 57758753, 94477051, 36141486, 44590416, 53781423, 29919751, 56684177,
//     7991242, 83676998, 81415646, 71732205, 94409566, 22866581, 55385173, 67871809, 73486966,
//     37845258, 13405942, 95543044, 32723938, 83590435, 95613025, 87979077, 49812308, 16807286,
//     41838221, 6183196, 87636370, 32227637, 97959184, 29083739, 5437149, 70213513, 71563028,
//     88462217, 81035013, 7279077, 3479370, 23191198, 87694397, 12439349, 25009737, 11018489,
//     5101357, 36064118, 74761957, 7867708, 20035814, 41264870, 98183142, 7599895, 43127299,
//     94142544, 52566054, 14740009, 30102466, 5552143, 40237552, 86121530, 77072124, 9012208,
//     75385561, 14930246, 50464116, 93255450, 39413782, 21826712, 59644925, 48731751, 32457814,
//     96608282, 24271960, 75411092, 17819031, 94742582, 25170220, 39670305, 98141409, 46026882,
//     51069429, 22357108, 8591570, 24210523, 24454888, 50369223, 56574666, 81862782, 28230654,
//     63707528, 9145950, 37072928, 72090734, 98815211, 21101598, 23118628, 3173946, 63522699,
//     46181580, 33811894, 16597640, 40074179, 54200918, 81474163, 84548421, 8074149, 55102268,
//     12997636, 35254111, 13562334, 6903949, 95749752, 96240894, 52138588, 712407, 12469016,
//     96816540, 10113124, 71475241, 49158624, 48531997, 37980556, 65479245, 89649374, 4106187,
//     19674266, 44731793, 30375226, 14114338, 16591207, 66520465, 71728654, 722025, 97272325,
//     92959680, 65442469, 37114197, 24568964, 80947214, 34570752, 51436981, 57592067, 91138177,
//     79681889, 84329901, 21146784, 51722345, 24182947, 27265632, 316072, 1,
// ];

pub(crate) fn forward_ntt(mut a: &mut [i64; 256]) {
    for i in 1..=8 {
        let m = 1 << (8 - i);
        for j in 0..(1 << (i - 1)) {
            let t = 2 * j * m;
            for k in 0..m {
                butterfly(&mut a, t + k, t + k + m, 2 * k * (1 << (i - 1)));
            }
        }
    }
    for e in a.iter_mut() {
        *e %= Q;
    }
}
pub(crate) fn reverse_ntt(mut a: &mut [i64; 256]) {
    rearrange(&mut a);

    for i in 1..=8 {
        let m = 1 << (8 - i);
        for j in 0..(1 << (i - 1)) {
            let t = 2 * j * m;
            for k in 0..m {
                butterfly(&mut a, t + k, t + k + m, 512 - 2 * k * (1 << (i - 1)));
            }
        }
    }
    rearrange(&mut a);
    for i in 0..256 {
        a[i] = (a[i] * NORM_FACTOR % Q) * ROOTS[512 - i] % Q;
    }
    for (i, e) in a.iter_mut().enumerate() {
        *e = (*e) * ROOTS[i] % Q;
    }
}

fn butterfly(a: &mut [i64; 256], in1: usize, in2: usize, inw: usize) {
    let mut xp = a[in1] + a[in2];
    if xp > Q * 2 {
        xp -= 2 * Q;
    }
    let tp = (2 * Q + a[in1] - a[in2]) as i128;
    // println!("{}, {}, {}, {}", tp, W[inw], a[in1], a[in2]);
    let qp = ((tp * W[inw]) >> 64) as i64;
    a[in1] = xp;
    a[in2] = (tp as i64) * ROOTS[inw] - qp * Q;
}

fn rearrange(a: &mut [i64; 256]) {
    for i in 0..256 {
        if POSITION[i] > i {
            let tmp = a[i];
            a[i] = a[POSITION[i]];
            a[POSITION[i]] = tmp;
        }
    }
}

#[test]
fn test_ntt() {
    use rand::{CryptoRng, RngCore};
    let mut rng = rand::thread_rng();
    let mut a = [0i64; 256];
    for e in a.iter_mut() {
        *e = rng.next_u32() as i64 % Q;
    }

    println!("{:?}", &a[0..32]);
    let b = a.clone();
    forward_ntt(&mut a);
    println!("{:?}", &a[0..32]);
    reverse_ntt(&mut a);
    println!("{:?}", &a[0..32]);
    for i in 0..256 {
        assert_eq!(a[i], b[i]);
    }

    // let mut a = [0i64; 256];
    // for e in a.iter_mut() {
    //     *e = rng.next_u32() as i64 % Q;
    // }
    // let mut b = [0i64; 64];
    // for e in b.iter_mut() {
    //     *e = rng.next_u32() as i64 % Q;
    // }
    //
    //
}
